{% extends "template/roottemplate.html" %}

{% block content %}
<div class="columns">
	<div class="column is-4 ">
		<form id="formInput" method="post" enctype="multipart/form-data">
			{% csrf_token %}
			<div class="field">
				<label class="label"><span class="title">Chọn ảnh</span></label>
				<div class="file is-info has-name">
					<label class="file-label">
						<input class="file-input" type="file" name="image">
						<button class="is-hidden" type="submit">Upload file</button>
						<span class="file-cta">
							<span class="file-icon">
								<i class="fas fa-upload"></i>
							</span>
							<span class="file-label">
								Chọn ảnh
							</span>
						</span>

						<span class="file-name">
							<span class="">{{ url }}</span>
						</span>

					</label>
				</div>
			</div>
			{% if url %}
			<div class="field has-text-centered">
				<img id="fileChoosePreview" src="{{ url }}">
			</div>
			{% endif %}
		</form>
	</div>
	{% if traffictrainid %}
	<div class="is-divider-vertical "></div>
	<div id="resultColumn" class="column has-result">
		<p id="traffictrainidContainer" class="is-hidden">{{ traffictrainid }}</p>
		<div class="field">
			<label class="label"><span class="title">Kết quả</span></label>
		</div>
		<div class="show-when-has-result">
			<div class=" notification box is-dark">
				<article id="trafficResultContainer" class="media">
					<figure class="media-left">
						<p class="image is-64x64 ">
							<img class="is-rounded" snb-key="image" snb-key-src="image">
						</p>
					</figure>
					<div class="media-content">
						<div class="content">
							<p>
								<strong snb-key="name"></strong>
								<span snb-key="description"></span>
							</p>
						</div>
					</div>
				</article>
			</div>
			<div class="field">
				<label class="label"><span class="subtitle">Góp ý cho ứng dụng</span></label>
			</div>
			<div class="buttons">
				<button onclick="indexrender.thankReport()" class="button is-success"><span class="icon"><i
							class="fa fa-check"></i></span><span>Kết quả
						đúng</span></button>
				<button onclick="indexrender.thankReport()" class="button is-danger"><span class="icon"><i
							class="fa fa-times"></i></span><span>Kết quả
						chưa đúng</span></button>
				<button onclick="indexrender.showDetail()" class="button is-info"><span class="icon"><i
							class="fa fa-search"></i></span><span>Xem chi tiết </span></button><a
					class="button is-light is-dark" href="https://github.com/quangkhoiuit98/trafficsignrecognize"
					target="_blank"><span class="icon"><i class="fab fa-github"></i></span><span>Star Github</span></a>

			</div>
		</div>
		<div class="hidden-when-has-result notification">Biển báo chưa hỗ trợ hoặc không tìm thấy biển báo trong hình.
			Xem thêm thông tin biển báo <a class="has-text-link" href="/trafficinfomation" target="_blank">tại đây</a>
		</div>
	</div>
	{% endif%}
</div>
<div id="detailSection" class="columns is-multiline is-hidden">
	<div class="column is-12">
		<div class="is-divider"></div>
		<p class="title">Chi tiết xử lý</p>
	</div>
	<div class="column is-4">
		<div class="field">
			<label class="label"><span>original</span></label>
			<img src="/static/image/original.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Mask Range 1</span></label>
			<img src="/static/image/markrange1.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Mask Range 2</span></label>
			<img src="/static/image/markrange2.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Mask for Red Region</span></label>
			<img src="/static/image/maskforredregion.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Mask for Red Rigon</span></label>
			<img src="/static/image/maskforredrigon.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Edge map</span></label>
			<img src="/static/image/edgemap.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Contour - No Restriction</span></label>
			<img src="/static/image/contournorestriction.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Contours - Restricted for Large Region</span></label>
			<img src="/static/image/contourrestrictedforlargeregion.jpg">
		</div>
		<div class="field">
			<label class="label"><span>Crop</span></label>
			<img src="/static/image/cropimage.jpg">
		</div>

	</div>
	<div class="column is-8">
		<pre style='color:#000000;background:#f5f5f5;'>
<span style='color:#800000; font-weight:bold; '>from</span> django<span style='color:#808030; '>.</span>shortcuts <span style='color:#800000; font-weight:bold; '>import</span> render
<span style='color:#800000; font-weight:bold; '>from</span> django<span style='color:#808030; '>.</span>http <span style='color:#800000; font-weight:bold; '>import</span> HttpResponse
<span style='color:#800000; font-weight:bold; '>from</span> django<span style='color:#808030; '>.</span>http <span style='color:#800000; font-weight:bold; '>import</span> JsonResponse
<span style='color:#800000; font-weight:bold; '>from</span> django<span style='color:#808030; '>.</span>views<span style='color:#808030; '>.</span>generic <span style='color:#800000; font-weight:bold; '>import</span> TemplateView
<span style='color:#800000; font-weight:bold; '>from</span> django<span style='color:#808030; '>.</span>core<span style='color:#808030; '>.</span>files<span style='color:#808030; '>.</span>storage <span style='color:#800000; font-weight:bold; '>import</span> FileSystemStorage
<span style='color:#800000; font-weight:bold; '>import</span> cv2
<span style='color:#800000; font-weight:bold; '>import</span> numpy <span style='color:#800000; font-weight:bold; '>as</span> np
<span style='color:#800000; font-weight:bold; '>import</span> matplotlib<span style='color:#808030; '>.</span>pyplot <span style='color:#800000; font-weight:bold; '>as</span> plt
<span style='color:#800000; font-weight:bold; '>from</span> skimage <span style='color:#800000; font-weight:bold; '>import</span> io
<span style='color:#800000; font-weight:bold; '>import</span> random
<span style='color:#800000; font-weight:bold; '>from</span> tensorflow<span style='color:#808030; '>.</span>keras<span style='color:#808030; '>.</span>models <span style='color:#800000; font-weight:bold; '>import</span> load_model
<span style='color:#800000; font-weight:bold; '>from</span> PIL <span style='color:#800000; font-weight:bold; '>import</span> Image
<span style='color:#800000; font-weight:bold; '>import</span> os
<span style='color:#800000; font-weight:bold; '>import</span> sys


os<span style='color:#808030; '>.</span>environ<span style='color:#808030; '>[</span><span style='color:#0000e6; '>'KMP_DUPLICATE_LIB_OK'</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'True'</span>


<span style='color:#800000; font-weight:bold; '>def</span> uploadFile<span style='color:#808030; '>(</span>request<span style='color:#808030; '>)</span><span style='color:#808030; '>:</span>
	context <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span><span style='color:#800080; '>}</span>
	<span style='color:#800000; font-weight:bold; '>if</span> request<span style='color:#808030; '>.</span>method <span style='color:#44aadd; '>==</span> <span style='color:#0000e6; '>'POST'</span><span style='color:#808030; '>:</span>
	uploaded_file <span style='color:#808030; '>=</span> request<span style='color:#808030; '>.</span>FILES<span style='color:#808030; '>[</span><span style='color:#0000e6; '>'image'</span><span style='color:#808030; '>]</span>
	fs <span style='color:#808030; '>=</span> FileSystemStorage<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
	name <span style='color:#808030; '>=</span> fs<span style='color:#808030; '>.</span>save<span style='color:#808030; '>(</span>uploaded_file<span style='color:#808030; '>.</span>name<span style='color:#808030; '>,</span> uploaded_file<span style='color:#808030; '>)</span>
	context<span style='color:#808030; '>[</span><span style='color:#0000e6; '>'url'</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> fs<span style='color:#808030; '>.</span>url<span style='color:#808030; '>(</span>name<span style='color:#808030; '>)</span>
	<span style='color:#800000; font-weight:bold; '>return</span> context


<span style='color:#800000; font-weight:bold; '>def</span> imreadx<span style='color:#808030; '>(</span>url<span style='color:#808030; '>)</span><span style='color:#808030; '>:</span>
	img <span style='color:#808030; '>=</span> io<span style='color:#808030; '>.</span>imread<span style='color:#808030; '>(</span>url<span style='color:#808030; '>)</span>
	outimg <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>cvtColor<span style='color:#808030; '>(</span>img<span style='color:#808030; '>,</span> cv2<span style='color:#808030; '>.</span>COLOR_RGB2BGR<span style='color:#808030; '>)</span>
	<span style='color:#800000; font-weight:bold; '>return</span> outimg


<span style='color:#800000; font-weight:bold; '>def</span> imshowx<span style='color:#808030; '>(</span>img<span style='color:#808030; '>,</span> title<span style='color:#808030; '>=</span><span style='color:#0000e6; '>'B2DL'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>:</span>
	fig_size <span style='color:#808030; '>=</span> plt<span style='color:#808030; '>.</span>rcParams<span style='color:#808030; '>[</span><span style='color:#0000e6; '>"figure.figsize"</span><span style='color:#808030; '>]</span>
	fig_size<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>12</span>
	fig_size<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>4</span>
	plt<span style='color:#808030; '>.</span>rcParams<span style='color:#808030; '>[</span><span style='color:#0000e6; '>"figure.figsize"</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> fig_size

	plt<span style='color:#808030; '>.</span>axis<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'off'</span><span style='color:#808030; '>)</span>
	plt<span style='color:#808030; '>.</span>title<span style='color:#808030; '>(</span>title<span style='color:#808030; '>)</span>
	plt<span style='color:#808030; '>.</span>imshow<span style='color:#808030; '>(</span>cv2<span style='color:#808030; '>.</span>cvtColor<span style='color:#808030; '>(</span>img<span style='color:#808030; '>,</span> cv2<span style='color:#808030; '>.</span>COLOR_BGR2RGB<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
	plt<span style='color:#808030; '>.</span>show<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>


<span style='color:#800000; font-weight:bold; '>def</span> imshowgrayx<span style='color:#808030; '>(</span>img<span style='color:#808030; '>,</span> title<span style='color:#808030; '>=</span><span style='color:#0000e6; '>'BD2L'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>:</span>
	plt<span style='color:#808030; '>.</span>axis<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'off'</span><span style='color:#808030; '>)</span>
	plt<span style='color:#808030; '>.</span>title<span style='color:#808030; '>(</span>title<span style='color:#808030; '>)</span>
	plt<span style='color:#808030; '>.</span>imshow<span style='color:#808030; '>(</span>img<span style='color:#808030; '>,</span> cmap<span style='color:#808030; '>=</span>plt<span style='color:#808030; '>.</span>get_cmap<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'gray'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
	plt<span style='color:#808030; '>.</span>show<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>


<span style='color:#800000; font-weight:bold; '>def</span> cropAndDetectTrafficSign<span style='color:#808030; '>(</span>context<span style='color:#808030; '>)</span><span style='color:#808030; '>:</span>

	<span style='color:#800000; font-weight:bold; '>try</span><span style='color:#808030; '>:</span>
		currentPythonFilePath <span style='color:#808030; '>=</span> os<span style='color:#808030; '>.</span>getcwd<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
		modelUrl <span style='color:#808030; '>=</span> currentPythonFilePath<span style='color:#44aadd; '>+</span><span style='color:#0000e6; '>'/static/model/model.h5'</span>

		saveDetectImageUrl <span style='color:#808030; '>=</span> currentPythonFilePath<span style='color:#44aadd; '>+</span><span style='color:#0000e6; '>'/static/image/'</span>
		url <span style='color:#808030; '>=</span> currentPythonFilePath <span style='color:#44aadd; '>+</span> context<span style='color:#808030; '>[</span><span style='color:#0000e6; '>'url'</span><span style='color:#808030; '>]</span>

		imageType <span style='color:#808030; '>=</span> url<span style='color:#808030; '>.</span>split<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'.'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span>

		img <span style='color:#808030; '>=</span> imreadx<span style='color:#808030; '>(</span>url<span style='color:#808030; '>)</span>
		hsv <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>cvtColor<span style='color:#808030; '>(</span>img<span style='color:#808030; '>,</span> cv2<span style='color:#808030; '>.</span>COLOR_BGR2HSV<span style='color:#808030; '>)</span>
		mask_r1 <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>inRange<span style='color:#808030; '>(</span>hsv<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>100</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>100</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
		mask_r2 <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>inRange<span style='color:#808030; '>(</span>hsv<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>160</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>100</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>100</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>180</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
		mask_r <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>bitwise_or<span style='color:#808030; '>(</span>mask_r1<span style='color:#808030; '>,</span> mask_r2<span style='color:#808030; '>)</span>
		target <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>bitwise_and<span style='color:#808030; '>(</span>img<span style='color:#808030; '>,</span> img<span style='color:#808030; '>,</span> mask<span style='color:#808030; '>=</span>mask_r<span style='color:#808030; '>)</span>
		gblur <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>GaussianBlur<span style='color:#808030; '>(</span>mask_r<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>9</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>9</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>
		edge_img <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>Canny<span style='color:#808030; '>(</span>gblur<span style='color:#808030; '>,</span> <span style='color:#008c00; '>30</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>150</span><span style='color:#808030; '>)</span>

		cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'original.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> img<span style='color:#808030; '>)</span>
		cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'markrange1.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> mask_r1<span style='color:#808030; '>)</span>
		cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'markrange2.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> mask_r2<span style='color:#808030; '>)</span>
		cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'maskforredregion.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> mask_r<span style='color:#808030; '>)</span>
		cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'maskforredrigon.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> target<span style='color:#808030; '>)</span>
		cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'edgemap.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> edge_img<span style='color:#808030; '>)</span>

		img2 <span style='color:#808030; '>=</span> img<span style='color:#808030; '>.</span>copy<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
		itmp<span style='color:#808030; '>,</span> cnts<span style='color:#808030; '>,</span> hierarchy <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>findContours<span style='color:#808030; '>(</span>
			edge_img<span style='color:#808030; '>.</span>copy<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> cv2<span style='color:#808030; '>.</span>RETR_EXTERNAL<span style='color:#808030; '>,</span> cv2<span style='color:#808030; '>.</span>CHAIN_APPROX_SIMPLE<span style='color:#808030; '>)</span>
		cv2<span style='color:#808030; '>.</span>drawContours<span style='color:#808030; '>(</span>img2<span style='color:#808030; '>,</span> cnts<span style='color:#808030; '>,</span> <span style='color:#44aadd; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span>

		cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'contournorestriction.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> img2<span style='color:#808030; '>)</span>

		img2 <span style='color:#808030; '>=</span> img<span style='color:#808030; '>.</span>copy<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span>
		<span style='color:#800000; font-weight:bold; '>try</span><span style='color:#808030; '>:</span>
			<span style='color:#800000; font-weight:bold; '>for</span> cnt <span style='color:#800000; font-weight:bold; '>in</span> cnts<span style='color:#808030; '>:</span>
			area <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>contourArea<span style='color:#808030; '>(</span>cnt<span style='color:#808030; '>)</span>
			<span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>area <span style='color:#44aadd; '>&lt;</span> <span style='color:#008c00; '>1000</span><span style='color:#808030; '>)</span><span style='color:#808030; '>:</span>
			<span style='color:#800000; font-weight:bold; '>continue</span>
			ellipse <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>fitEllipse<span style='color:#808030; '>(</span>cnt<span style='color:#808030; '>)</span>
			cv2<span style='color:#808030; '>.</span>ellipse<span style='color:#808030; '>(</span>img2<span style='color:#808030; '>,</span> ellipse<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span>
			x<span style='color:#808030; '>,</span> y<span style='color:#808030; '>,</span> w<span style='color:#808030; '>,</span> h <span style='color:#808030; '>=</span> cv2<span style='color:#808030; '>.</span>boundingRect<span style='color:#808030; '>(</span>cnt<span style='color:#808030; '>)</span>
			a<span style='color:#808030; '>,</span> b<span style='color:#808030; '>,</span> c<span style='color:#808030; '>,</span> d <span style='color:#808030; '>=</span> x<span style='color:#808030; '>,</span> y<span style='color:#808030; '>,</span> w<span style='color:#808030; '>,</span> h
			cv2<span style='color:#808030; '>.</span>rectangle<span style='color:#808030; '>(</span>img2<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span>x<span style='color:#808030; '>,</span> y<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span>x<span style='color:#44aadd; '>+</span>w<span style='color:#808030; '>,</span> y<span style='color:#44aadd; '>+</span>h<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>255</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span>
			
			cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'contourrestrictedforlargeregion.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> img2<span style='color:#808030; '>)</span>

			crop <span style='color:#808030; '>=</span> img<span style='color:#808030; '>[</span>b<span style='color:#808030; '>:</span>b<span style='color:#44aadd; '>+</span>d<span style='color:#808030; '>,</span> a<span style='color:#808030; '>:</span>a<span style='color:#44aadd; '>+</span>c<span style='color:#808030; '>]</span>
			cv2<span style='color:#808030; '>.</span>imwrite<span style='color:#808030; '>(</span>saveDetectImageUrl <span style='color:#44aadd; '>+</span> <span style='color:#0000e6; '>'cropimage.'</span><span style='color:#44aadd; '>+</span>imageType<span style='color:#808030; '>,</span> img2<span style='color:#808030; '>)</span>

		<span style='color:#800000; font-weight:bold; '>except</span><span style='color:#808030; '>:</span>
			<span style='color:#800000; font-weight:bold; '>print</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>"cannot border box"</span><span style='color:#808030; '>)</span>
			crop <span style='color:#808030; '>=</span> img
		model <span style='color:#808030; '>=</span> load_model<span style='color:#808030; '>(</span>modelUrl<span style='color:#808030; '>)</span>
		data <span style='color:#808030; '>=</span> <span style='color:#808030; '>[</span><span style='color:#808030; '>]</span>
		image_from_array <span style='color:#808030; '>=</span> Image<span style='color:#808030; '>.</span>fromarray<span style='color:#808030; '>(</span>crop<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'RGB'</span><span style='color:#808030; '>)</span>
		crop <span style='color:#808030; '>=</span> image_from_array<span style='color:#808030; '>.</span>resize<span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>30</span><span style='color:#808030; '>,</span> <span style='color:#008c00; '>30</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
		data<span style='color:#808030; '>.</span>append<span style='color:#808030; '>(</span>np<span style='color:#808030; '>.</span>array<span style='color:#808030; '>(</span>crop<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
		X_test <span style='color:#808030; '>=</span> np<span style='color:#808030; '>.</span>array<span style='color:#808030; '>(</span>data<span style='color:#808030; '>)</span>
		X_test <span style='color:#808030; '>=</span> X_test<span style='color:#808030; '>.</span>astype<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'float32'</span><span style='color:#808030; '>)</span><span style='color:#44aadd; '>/</span><span style='color:#008c00; '>255</span>
		prediction <span style='color:#808030; '>=</span> model<span style='color:#808030; '>.</span>predict_classes<span style='color:#808030; '>(</span>X_test<span style='color:#808030; '>)</span>
		<span style='color:#800000; font-weight:bold; '>return</span> prediction
	<span style='color:#800000; font-weight:bold; '>except</span><span style='color:#808030; '>:</span>
		<span style='color:#800000; font-weight:bold; '>print</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Bug when model predict"</span><span style='color:#808030; '>)</span>
		<span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>[</span><span style='color:#008c00; '>10000</span><span style='color:#808030; '>]</span>


<span style='color:#800000; font-weight:bold; '>def</span> detectTrafficSign<span style='color:#808030; '>(</span>request<span style='color:#808030; '>)</span><span style='color:#808030; '>:</span>
	context <span style='color:#808030; '>=</span> uploadFile<span style='color:#808030; '>(</span>request<span style='color:#808030; '>)</span>
	prediction <span style='color:#808030; '>=</span> cropAndDetectTrafficSign<span style='color:#808030; '>(</span>context<span style='color:#808030; '>)</span>
	context<span style='color:#808030; '>[</span><span style='color:#0000e6; '>'traffictrainid'</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> prediction<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span>
	<span style='color:#800000; font-weight:bold; '>return</span> context
</pre>
		<!--Created using ToHtml.com on 2019-11-11 03:53:43 UTC -->
	</div>
</div>
<script>
	document.addEventListener('DOMContentLoaded', (event) => {

		indexrender.build();
	});
</script>

{% endblock %}